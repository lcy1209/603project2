package com.example.hansei.programs;

import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/programs/applications")
@CrossOrigin(origins = "http://localhost:3000")
public class ProgramApplicationController {
    private final ApplicationService applicationService;

    public ProgramApplicationController(ApplicationService applicationService) {
        this.applicationService = applicationService;
    }

    /**
     * âœ… íŠ¹ì • ì‚¬ìš©ìì˜ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ (í”„ë¡ íŠ¸ì—ì„œ í•„ìš”í•œ ì •ë³´ë§Œ ë°˜í™˜)
     */
    @GetMapping("/{userId}")
    public ResponseEntity<List<ApplicationDto>> getUserApplications(@PathVariable Long userId) {
        List<Application> applications = applicationService.getUserApplications(userId);

        // âœ… DTO ë³€í™˜í•˜ì—¬ í•„ìš”í•œ ë°ì´í„°ë§Œ ë°˜í™˜
        List<ApplicationDto> applicationDtos = applications.stream()
                .map(app -> new ApplicationDto(
                        app.getId(),
                        app.getUser().getName(),  // ì‹ ì²­ì ì´ë¦„
                        app.getProgram().getPosterName(),  // ê¸°ê´€ëª…
                        app.getProgram().getName(),  // í”„ë¡œê·¸ë¨ëª…
                        app.getProgram().getStartDate(),
                        app.getProgram().getEndDate(),
                        app.getStatus() == Application.ApplicationStatus.APPLIED ? "ëª¨ì§‘ì¤‘" : "ì·¨ì†Œë¨"  // ìƒíƒœ ë³€í™˜
                ))
                .collect(Collectors.toList());

        System.out.println("ğŸ“Œ [ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ] userId=" + userId + " â†’ ì‹ ì²­ ë‚´ì—­: " + applicationDtos);
        return ResponseEntity.ok(applicationDtos);
    }

    /**
     * âœ… í”„ë¡œê·¸ë¨ ì‹ ì²­ (JSON ê°ì²´ë¡œ userId ë°›ìŒ)
     */
    @PostMapping("/{programId}/apply")
    public ResponseEntity<String> applyForProgram(@PathVariable Long programId, @RequestBody UserRequest request) {
        Optional<Application> application = applicationService.applyForProgram(request.getUserId(), programId);
        
        if (application.isPresent()) {
            System.out.println("âœ… [ì‹ ì²­ ì™„ë£Œ] userId=" + request.getUserId() + ", programId=" + programId);
            return ResponseEntity.ok("ì‹ ì²­ ì™„ë£Œ");
        } else {
            System.out.println("ğŸš¨ [ì‹ ì²­ ì‹¤íŒ¨] ì´ë¯¸ ì‹ ì²­í–ˆê±°ë‚˜ ì •ì›ì´ ì´ˆê³¼ë¨: userId=" + request.getUserId() + ", programId=" + programId);
            return ResponseEntity.badRequest().body("ì‹ ì²­ ì‹¤íŒ¨: ì´ë¯¸ ì‹ ì²­í–ˆê±°ë‚˜ ì •ì›ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    /**
     * âœ… ì‚¬ìš©ì ìš”ì²­ì„ ë°›ê¸° ìœ„í•œ ë‚´ë¶€ DTO (JSON ìš”ì²­ ì²˜ë¦¬)
     */
    static class UserRequest {
        private Long userId;

        public Long getUserId() {
            return userId;
        }

        public void setUserId(Long userId) {
            this.userId = userId;
        }
    }
}