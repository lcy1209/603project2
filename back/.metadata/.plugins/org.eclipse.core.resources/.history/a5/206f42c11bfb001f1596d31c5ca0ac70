package com.example.hansei.programs;

import com.example.hansei.entity.HanUser;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.transaction.Transactional;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class ProgramService {
    private final ProgramRepository programRepository;
    private final ApplicationRepository applicationRepository;
    private final SimpMessagingTemplate messagingTemplate;
    private final String uploadDir = "uploads/";
    private final ObjectMapper objectMapper = new ObjectMapper();

    @PersistenceContext
    private EntityManager entityManager;

    public ProgramService(ProgramRepository programRepository, ApplicationRepository applicationRepository, SimpMessagingTemplate messagingTemplate) {
        this.programRepository = programRepository;
        this.applicationRepository = applicationRepository;
        this.messagingTemplate = messagingTemplate;
        createUploadDir();
    }

    /**
     * âœ… í”„ë¡œê·¸ë¨ ì¶”ê°€ (ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ì„ DBì— ì €ì¥)
     */
    @Transactional
    public Program addProgram(Program program) {
        return programRepository.save(program);
    }

    /**
     * âœ… íŠ¹ì • ì‚¬ìš©ìê°€ ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ ì¡°íšŒ (ì‹ ì²­ì ì •ë³´ í¬í•¨)
     */
    public List<ApplicationDto> getMyPrograms(Long userId) {
        return applicationRepository.findByUserUserId(userId)
                .stream()
                .map(ApplicationDto::fromApplication)
                .collect(Collectors.toList());
    }

    // âœ… ëª¨ë“  í”„ë¡œê·¸ë¨ ì¡°íšŒ
    public List<Program> getAllPrograms() {
        return programRepository.findAll();
    }

    // âœ… íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡œê·¸ë¨ ì¡°íšŒ
    public List<Program> getProgramsByCategory(String category) {
        try {
            return programRepository.findByCategory(Program.Category.valueOf(category));
        } catch (IllegalArgumentException e) {
            throw new IllegalArgumentException("ğŸš¨ ì˜ëª»ëœ ì¹´í…Œê³ ë¦¬ ê°’ì…ë‹ˆë‹¤: " + category);
        }
    }

    // âœ… IDë¡œ íŠ¹ì • í”„ë¡œê·¸ë¨ ì¡°íšŒ
    public Optional<Program> getProgramById(Long id) {
        return programRepository.findById(id);
    }

    /**
     * âœ… í”„ë¡œê·¸ë¨ ì‹ ì²­ (ì‚¬ìš©ìê°€ íŠ¹ì • í”„ë¡œê·¸ë¨ì„ ì‹ ì²­)
     */
    @Transactional
    public boolean applyForProgram(Long userId, Long programId) {
        // âœ… í”„ë¡œê·¸ë¨ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        Program program = programRepository.findById(programId)
                .orElseThrow(() -> new IllegalArgumentException("ğŸš¨ í”„ë¡œê·¸ë¨ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. programId=" + programId));

        // âœ… ì‚¬ìš©ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        HanUser user = entityManager.find(HanUser.class, userId);
        if (user == null) {
            throw new IllegalArgumentException("ğŸš¨ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. userId=" + userId);
        }

        // âœ… ê°™ì€ ìœ ì €ê°€ ì´ë¯¸ ì‹ ì²­í–ˆëŠ”ì§€ í™•ì¸ (existsBy â†’ findBy ì‚¬ìš©)
        if (applicationRepository.findByUserUserIdAndProgramId(userId, programId).isPresent()) {
            throw new IllegalArgumentException("ğŸš¨ ì´ë¯¸ ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. userId=" + userId + ", programId=" + programId);
        }

        // âœ… ì •ì› ì´ˆê³¼ ì—¬ë¶€ í™•ì¸
        if (program.getCurrentParticipants() >= program.getMaxParticipants()) {
            throw new IllegalStateException("ğŸš¨ ì‹ ì²­ ì •ì›ì„ ì´ˆê³¼í•˜ì˜€ìŠµë‹ˆë‹¤. programId=" + programId);
        }

        // âœ… ì‹ ì²­ ê°ì²´ ìƒì„± ë° ì €ì¥
        Application application = new Application();
        application.setUser(user);
        application.setProgram(program);
        application.setStatus(Application.ApplicationStatus.APPLIED);
        applicationRepository.save(application);

        // âœ… ì‹ ì²­ì ìˆ˜ ì¦ê°€
        program.setCurrentParticipants(program.getCurrentParticipants() + 1);
        programRepository.save(program);

        // âœ… WebSocketì„ í†µí•´ ì‹ ì²­ ë°˜ì˜
        messagingTemplate.convertAndSend("/topic/programs", new WebSocketResponse(userId, programId, true, "âœ… ì‹ ì²­ ì™„ë£Œ"));

        return true;
    }

    // âœ… ì¼ì • ë°ì´í„°ë¥¼ JSONì—ì„œ ê°ì²´ë¡œ ë³€í™˜
    public List<Schedule> parseSchedules(String schedulesJson) {
        try {
            return objectMapper.readValue(schedulesJson, new TypeReference<List<Schedule>>() {});
        } catch (Exception e) {
            throw new RuntimeException("ğŸš¨ ì¼ì • ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage(), e);
        }
    }

    // âœ… ì´ë¯¸ì§€ ì €ì¥
    public String saveImage(MultipartFile image) throws IOException {
        String uniqueFilename = UUID.randomUUID().toString() + "_" + image.getOriginalFilename();
        Path filePath = Paths.get(uploadDir, uniqueFilename);
        Files.createDirectories(filePath.getParent());
        Files.write(filePath, image.getBytes());
        return uniqueFilename;
    }

    // âœ… ì´ë¯¸ì§€ ë¡œë“œ
    public byte[] loadImage(String filename) throws IOException {
        Path filePath = Paths.get(uploadDir, filename);
        if (Files.exists(filePath)) {
            return Files.readAllBytes(filePath);
        } else {
            throw new IOException("ğŸš¨ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + filename);
        }
    }

    // âœ… ì—…ë¡œë“œ ë””ë ‰í„°ë¦¬ ìƒì„±
    private void createUploadDir() {
        File directory = new File(uploadDir);
        if (!directory.exists()) {
            directory.mkdirs();
        }
    }

    /**
     * âœ… WebSocket ì‘ë‹µ DTO (ë‚´ë¶€ í´ë˜ìŠ¤)
     */
    
    private static class WebSocketResponse {
        private final Long userId;
        private final Long programId;
        private final boolean isApplied;
        private final String message;

        public WebSocketResponse(Long userId, Long programId, boolean isApplied, String message) {
            this.userId = userId;
            this.programId = programId;
            this.isApplied = isApplied;
            this.message = message;
        }

        public Long getUserId() { return userId; }
        public Long getProgramId() { return programId; }
        public boolean isApplied() { return isApplied; }
        public String getMessage() { return message; }
    }
}