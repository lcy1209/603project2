package com.example.hansei.recruitmentapi.service;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import com.example.hansei.recruitmentapi.dto.EventDto;
import com.example.hansei.recruitmentapi.repository.EventFavoriteRepository;
import com.fasterxml.jackson.databind.JsonNode;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class EventService {

	private final RestTemplate restTemplate = new RestTemplate();

    // authKeyë¥¼ application.propertiesì—ì„œ ì£¼ì… ë°›ìŒ
    @Value("${authKey}")
    private String authKey;

    private final XmlToJsonConverter xmlToJsonConverter;
    private final EventFavoriteRepository eventFavoriteRepository;

    public List<EventDto> searchWorkBoard(
            String returnType,
            String callTp,
            String eventType,
            String srchBgnDt,
            String srchEndDt,
            String areaCd,
            String keyword,
            int startPage,
            int display
    ) {
        try {
            if (authKey == null || authKey.isEmpty()) {
                throw new IllegalArgumentException("âŒ authKeyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            String apiUrl = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L11.do";

            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                    .queryParam("authKey", authKey)
                    .queryParam("returnType", returnType)
                    .queryParam("callTp", callTp)
                    .queryParam("startPage", startPage)
                    .queryParam("display", display);

            if (srchBgnDt != null && !srchBgnDt.isEmpty()) builder.queryParam("srchBgnDt", srchBgnDt);
            if (srchEndDt != null && !srchEndDt.isEmpty()) builder.queryParam("srchEndDt", srchEndDt);
            if (keyword != null && !keyword.isEmpty()) builder.queryParam("keyword", keyword);
            if (areaCd != null && !areaCd.isEmpty()) builder.queryParam("areaCd", areaCd);

            String finalUrl = builder.toUriString();
            System.out.println("ğŸ” ì™¸ë¶€ API í˜¸ì¶œ URL: " + finalUrl);

            ResponseEntity<String> response = restTemplate.getForEntity(finalUrl, String.class);
            System.out.println("ğŸ” API ì‘ë‹µ ë³¸ë¬¸: " + response.getBody());

            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                return parseExternalApiResponse(response.getBody());
            } else {
                System.err.println("âŒ API ì‘ë‹µ ì‹¤íŒ¨: HTTP " + response.getStatusCode());
                return Collections.emptyList();
            }
        } catch (Exception e) {
            System.err.println("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            e.printStackTrace();
            return Collections.emptyList();
        }
    }

    private List<EventDto> parseExternalApiResponse(String xmlResponse) {
    	try {
    	    // XMLì„ JSONìœ¼ë¡œ ë³€í™˜
    	    JsonNode root = xmlToJsonConverter.convertXmlToJson(xmlResponse);
    	    System.out.println("ğŸ” ë³€í™˜ëœ JSON: " + root.toString());
    	    if (root == null) {
    	        System.err.println("âŒ XMLì„ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    	        return Collections.emptyList();
    	    }

    	    // XMLì—ì„œ í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
    	    JsonNode dataArray = root.path("empEvent");
    	    if (!dataArray.isArray() || dataArray.isEmpty()) {
    	        System.err.println("âŒ API ì‘ë‹µ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    	        return Collections.emptyList();
    	    }
    	    
    	    // ë°ì´í„° íŒŒì‹±
    	    List<EventDto> eventList = new ArrayList<>();
    	    for (JsonNode eventNode : dataArray) {
    	        String eventNo = eventNode.path("eventNo").asText();
    	        String title = eventNode.path("eventNm").asText();
                String area = eventNode.path("area").asText();
                String areaCd = eventNode.path("areaCd").asText();
                String eventTerm = eventNode.path("eventTerm").asText();

                LocalDate startDate = null;
                LocalDate endDate = null;

                try {
                    String[] dates = eventTerm.split(" ~ ");
                    if (dates.length == 2) {
                        startDate = LocalDate.parse(dates[0].trim());
                        endDate = LocalDate.parse(dates[1].trim());
                    } else {
                        startDate = LocalDate.parse(eventNode.path("startDt").asText());
                        endDate = startDate;
                    }
                } catch (Exception e) {
                    System.err.println("âš ï¸ ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
                    startDate = LocalDate.now(); // ê¸°ë³¸ê°’ ì„¤ì •
                    endDate = LocalDate.now();
                }

                eventList.add(new EventDto(eventNo, title, area, areaCd, eventTerm, startDate, endDate));
            }

            return eventList;
        } catch (Exception e) {
            System.err.println("ğŸ”´ XML íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage());
            e.printStackTrace();
            return Collections.emptyList();
        }
    }
    
  //ìƒì„¸í˜ì´ì§€ ì™¸ë¶€api í˜¸ì¶œ
    public EventDetailDto getEventDetail(String eventNo, String areaCd) {
        try {
            System.out.println("ğŸ” areaCd ê°’: " + areaCd);

            if (authKey == null || authKey.isEmpty()) {
                throw new IllegalArgumentException("âŒ authKeyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            String apiUrl = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210D11.do";

            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                    .queryParam("authKey", authKey)
                    .queryParam("returnType", "XML")
                    .queryParam("callTp", "D")
                    .queryParam("eventNo", eventNo)
                    .queryParam("areaCd", areaCd);

            String finalUrl = builder.toUriString();
            System.out.println("ğŸ” ì™¸ë¶€ API í˜¸ì¶œ URL: " + finalUrl);

            ResponseEntity<String> response = restTemplate.getForEntity(finalUrl, String.class);
            System.out.println("ğŸ” API ì‘ë‹µ ë³¸ë¬¸: " + response.getBody());

            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                // XML ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
                JsonNode jsonNode = xmlToJsonConverter.convertXmlToJson(response.getBody());
                System.out.println("ğŸ” ë³€í™˜ëœ JSON: " + jsonNode.toString());

                // EventDetailDto ê°ì²´ ìƒì„±
                return new EventDetailDto(
                    jsonNode.path("eventNm").asText(), // í–‰ì‚¬ëª…
                    jsonNode.path("eventNm").asText(), // í–‰ì‚¬ëª…
                    jsonNode.path("area").asText(), // ì§€ì—­ (í•„ìš”í•œ ê²½ìš°)
                    jsonNode.path("areaCd").asText(), // ì§€ì—­ ì½”ë“œ (í•„ìš”í•œ ê²½ìš°)
                    jsonNode.path("eventTerm").asText(), // í–‰ì‚¬ ê¸°ê°„
                    jsonNode.path("eventPlc").asText(), // í–‰ì‚¬ ì¥ì†Œ
                    jsonNode.path("joinCoWantedInfo").asText(), // ì°¸ì—¬ ê¸°ì—… ì •ë³´
                    jsonNode.path("subMatter").asText(), // ì¶”ê°€ ì‚¬í•­
                    jsonNode.path("inqTelNo").asText(), // ë¬¸ì˜ ì „í™”ë²ˆí˜¸
                    jsonNode.path("fax").asText(), // íŒ©ìŠ¤ ë²ˆí˜¸
                    jsonNode.path("charger").asText(), // ë‹´ë‹¹ì
                    jsonNode.path("email").asText(), // ì´ë©”ì¼
                    jsonNode.path("visitPath").asText() // ë°©ë¬¸ ê²½ë¡œ
                );
            } else {
                System.err.println("âŒ API ì‘ë‹µ ì‹¤íŒ¨: HTTP " + response.getStatusCode());
                return null; // ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
            }
        } catch (Exception e) {
            System.err.println("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            e.printStackTrace();
            return null; // ì˜¤ë¥˜ ë°œìƒ ì‹œ null ë°˜í™˜
        }
    }
    
    public List<EventDto> getAllEvents() {
        try {
            String apiUrl = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L11.do";
            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                    .queryParam("authKey", authKey)
                    .queryParam("returnType", "XML")
                    .queryParam("callTp", "L")
                    .queryParam("startPage", 1)
                    .queryParam("display", 100);  // ìµœëŒ€ 100ê°œ ì¡°íšŒ

            String finalUrl = builder.toUriString();
            ResponseEntity<String> response = restTemplate.getForEntity(finalUrl, String.class);

            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                return parseExternalApiResponse(response.getBody());
            } else {
                System.err.println("âŒ API ì‘ë‹µ ì‹¤íŒ¨: HTTP " + response.getStatusCode());
                return Collections.emptyList();
            }
        } catch (Exception e) {
            System.err.println("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            return Collections.emptyList();
        }
    }

    // âœ… ì¦ê²¨ì°¾ê¸°í•œ ì´ë²¤íŠ¸ ëª©ë¡ ì¡°íšŒ
    public List<EventDto> getFavoriteEvents(Long userId) {
        List<String> favoriteEventNos = eventFavoriteRepository.findByUser_UserIdAndIsDeletedFalse(userId)
                .stream()
                .map(event -> event.getEventNo())
                .collect(Collectors.toList());

        // ì „ì²´ ì´ë²¤íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        List<EventDto> allEvents = getAllEvents();

        // ì¦ê²¨ì°¾ê¸°í•œ ì´ë²¤íŠ¸ë§Œ í•„í„°ë§
        return allEvents.stream()
                .filter(event -> favoriteEventNos.contains(event.getEventNo()))
                .collect(Collectors.toList());
    }
}