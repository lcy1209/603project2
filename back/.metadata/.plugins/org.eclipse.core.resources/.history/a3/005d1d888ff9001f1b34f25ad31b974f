package com.example.hansei.recruitmentapi.service;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import com.example.hansei.recruitmentapi.dto.EventDto;
import com.fasterxml.jackson.databind.JsonNode;

@Service
public class EventService {

    private final RestTemplate restTemplate = new RestTemplate();

    // authKeyë¥¼ application.propertiesì—ì„œ ì£¼ì… ë°›ìŒ
    @Value("${authKey}")
    private String authKey;

    private final XmlToJsonConverter xmlToJsonConverter;

    
    // XmlToJsonConverterë¥¼ ì£¼ì…ë°›ìŒ
    public EventService(XmlToJsonConverter xmlToJsonConverter) {
        this.xmlToJsonConverter = xmlToJsonConverter;
    }

    public List<EventDto> searchWorkBoard(
            String returnType,
            String callTp,
            String eventType,
            String srchBgnDt,
            String srchEndDt,
            String areaCd,
            String keyword,
            int startPage,
            int display
    ) {
        try {
            if (authKey == null || authKey.isEmpty()) {
                throw new IllegalArgumentException("âŒ authKeyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            String apiUrl = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L11.do";

            UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                    .queryParam("authKey", authKey)
                    .queryParam("returnType", returnType)
                    .queryParam("callTp", callTp)
                    .queryParam("startPage", startPage)
                    .queryParam("display", display);

            if (srchBgnDt != null && !srchBgnDt.isEmpty()) builder.queryParam("srchBgnDt", srchBgnDt);
            if (srchEndDt != null && !srchEndDt.isEmpty()) builder.queryParam("srchEndDt", srchEndDt);
            if (keyword != null && !keyword.isEmpty()) builder.queryParam("keyword", keyword);
            if (areaCd != null && !areaCd.isEmpty()) builder.queryParam("areaCd", areaCd);

            String finalUrl = builder.toUriString();
            System.out.println("ğŸ” ì™¸ë¶€ API í˜¸ì¶œ URL: " + finalUrl);

            ResponseEntity<String> response = restTemplate.getForEntity(finalUrl, String.class);
            System.out.println("ğŸ” API ì‘ë‹µ ë³¸ë¬¸: " + response.getBody());

            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                return parseExternalApiResponse(response.getBody());
            } else {
                System.err.println("âŒ API ì‘ë‹µ ì‹¤íŒ¨: HTTP " + response.getStatusCode());
                return Collections.emptyList();
            }
        } catch (Exception e) {
            System.err.println("âŒ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
            e.printStackTrace();
            return Collections.emptyList();
        }
    }

    private List<EventDto> parseExternalApiResponse(String xmlResponse) {
    	try {
    	    // XMLì„ JSONìœ¼ë¡œ ë³€í™˜
    	    JsonNode root = xmlToJsonConverter.convertXmlToJson(xmlResponse);
    	    System.out.println("ğŸ” ë³€í™˜ëœ JSON: " + root.toString());
    	    if (root == null) {
    	        System.err.println("âŒ XMLì„ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    	        return Collections.emptyList();
    	    }

    	    // XMLì—ì„œ í•„ìš”í•œ ë°ì´í„° ì¶”ì¶œ
    	    JsonNode dataArray = root.path("empEvent");
    	    if (!dataArray.isArray() || dataArray.isEmpty()) {
    	        System.err.println("âŒ API ì‘ë‹µ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    	        return Collections.emptyList();
    	    }
    	    
    	    // ë°ì´í„° íŒŒì‹±
    	    List<EventDto> eventList = new ArrayList<>();
    	    for (JsonNode eventNode : dataArray) {
    	        String eventNo = eventNode.path("eventNo").asText();
    	        String title = eventNode.path("eventNm").asText();
                String area = eventNode.path("area").asText();
                String areaCd = eventNode.path("areaCd").asText();
                String eventTerm = eventNode.path("eventTerm").asText();

                LocalDate startDate = null;
                LocalDate endDate = null;

                try {
                    String[] dates = eventTerm.split(" ~ ");
                    if (dates.length == 2) {
                        startDate = LocalDate.parse(dates[0].trim());
                        endDate = LocalDate.parse(dates[1].trim());
                    } else {
                        startDate = LocalDate.parse(eventNode.path("startDt").asText());
                        endDate = startDate;
                    }
                } catch (Exception e) {
                    System.err.println("âš ï¸ ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜ ë°œìƒ: " + e.getMessage());
                    startDate = LocalDate.now(); // ê¸°ë³¸ê°’ ì„¤ì •
                    endDate = LocalDate.now();
                }

                eventList.add(new EventDto(eventNo, title, area, areaCd, eventTerm, startDate, endDate));
            }

            return eventList;
        } catch (Exception e) {
            System.err.println("ğŸ”´ XML íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage());
            e.printStackTrace();
            return Collections.emptyList();
        }
    }
    
    public EventDto getEventDetail(String eventNo) {
        String apiUrl = "https://www.work24.go.kr/cm/openApi/call/wk/callOpenApiSvcInfo210L11.do";
        
        UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(apiUrl)
                .queryParam("authKey", authKey)
                .queryParam("returnType", "JSON")
                .queryParam("callTp", "D") // âœ… "D"ëŠ” ìƒì„¸ ì¡°íšŒ íƒ€ì…
                .queryParam("eventNo", eventNo);

        try {
            ResponseEntity<String> response = restTemplate.getForEntity(builder.toUriString(), String.class);
            return parseEventDetailResponse(response.getBody());
        } catch (Exception e) {
            System.err.println("âŒ ì´ë²¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜: " + e.getMessage());
            return null;
        }
    }

    // âœ… Worknet API ì‘ë‹µì„ EventDtoë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ ì¶”ê°€
    private EventDto parseEventDetailResponse(String jsonResponse) {
        try {
            JsonNode root = xmlToJsonConverter.convertXmlToJson(jsonResponse);
            JsonNode eventNode = root.path("empEvent").get(0);
            
            if (eventNode == null) {
                return null;
            }

            return new EventDto(
                eventNode.path("eventNo").asText(),
                eventNode.path("eventNm").asText(),
                eventNode.path("area").asText(),
                eventNode.path("areaCd").asText(),
                eventNode.path("eventTerm").asText(),
                LocalDate.parse(eventNode.path("startDt").asText()),
                LocalDate.parse(eventNode.path("endDt").asText())
            );
        } catch (Exception e) {
            System.err.println("âŒ ì´ë²¤íŠ¸ ìƒì„¸ JSON íŒŒì‹± ì˜¤ë¥˜: " + e.getMessage());
            return null;
        }
    }

}
